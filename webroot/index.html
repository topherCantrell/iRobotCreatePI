<!DOCTYPE html>
<html>
	<head>
	
		<title>Pi Bot</title>
		
		<link rel="stylesheet" href="ext/bootstrap-3.3.7.min.css" >
		<script src="ext/jquery-3.1.1.min.js"></script>
		<script src="ext/bootstrap-3.3.7.min.js" ></script>
		
		<style>
		    .glassPane {		       
			    background-color: #F0F0F0;
			    opacity: 0.75;
		    }
		</style>
		
		<script>
		
			var POWERstraight = 200;
			var POWERspin     = 100;
			
			var TIMEstraight  = 5000;
			var TIMEspin      = 1000;
			
			var driving=true;
			
			$(function() {	
						
				$("#btForward").bind("click", function() {
					if(driving) {					
						robotAjax("straight("+POWERstraight+")");
					} else {
						addScriptElement("img/forward.jpg");
					}
				});
				
				$("#btSpinCCW").bind("click", function() {
					if(driving) {
						robotAjax("SPIN("+POWERspin+",false)");
					} else {
						addScriptElement("img/spinCCW.jpg");
					}
				});
				
				$("#btStop").bind("click", function() {
					if(driving) {
						robotAjax("stop");	
					} else {
						//addScriptElement("img/forward.jpg");
					}
				});
				
				$("#btSpinCW").bind("click", function() {
					if(driving) {
						robotAjax("SPIN("+POWERspin+",true)");
					} else {
						addScriptElement("img/spinCW.jpg");
					}
				});
				
				$("#btBack").bind("click", function() {
					if(driving) {
						robotAjax("straight("+(-POWERstraight)+")");
					} else {
						addScriptElement("img/back.jpg");
					}
				});
				
				
				$("#btProgram").bind("click", function() {
					driving = false;
					$("#program").show();
					$("#btDrive").removeClass("btn-primary");
					$("#btProgram").addClass("btn-primary");
				});
				
				$("#btDrive").bind("click", function() {
					driving = true;
					$("#program").hide();
					$("#btDrive").addClass("btn-primary");
					$("#btProgram").removeClass("btn-primary");
				});
				
				$("#btClear").bind("click", function() {
					$("#programScript").empty();
					$("#programScript").append($("<img onclick='scriptClick(event)' class='cursor' height='75' src='img/cursor.jpg'>"));
				})
				
				$("#btRun").bind("click", runScript);
				
			});
			
			function addScriptElement(type) {
				// change cursor to NEXT
				var cur = $(".cursor");
				cur.removeClass("cursor");
				cur.attr("src","img/next.jpg");				
				// add element at cursor
				var ne = $("<img class='programElement' onclick='scriptClick(event)' height='75'>").attr("src",type);
				cur.after(ne);
				// add cursor after element
				ne.after($("<img onclick='scriptClick(event)' class='cursor' height='75' src='img/cursor.jpg'>"));
			}
			
			function robotAjax(cmd,cb) {
				$.post("/robot?command="+cmd,cb);
			}
			
			function scriptClick(e) {
				var ca = $(e.currentTarget);
				var type = ca.attr("src");
				if(type==="img/next.jpg") {
					var ce = $(".cursor");
					ce.removeClass("cursor");
					ce.attr("src","img/next.jpg");
					ca.attr("src","img/cursor.jpg");
					ca.addClass("cursor");
				} else if(type!=="img/cursor.jpg") {
					var ne = ca.next();
					var bf = ca.prev();
					ca.remove();
					if(ne.hasClass("cursor")) {
						bf.remove();
					} else {
						ne.remove();
					}					
				}
			}
			
			var scriptCommands = [];
			var scriptCommandsPos = 0;
			var currentCom;
			
			function nextScriptCommand() {
				if(scriptCommandsPos==scriptCommands.length) {
					robotAjax("stop",function() {
						$("#driveDiv").addClass("glassPane");
					});
					return;
				}
				var cmd = $(scriptCommands[scriptCommandsPos]);
				++scriptCommandsPos;
				
				var type = cmd.attr("src");
				currentCom = cmd;
				var i = type.indexOf(".jpg");
				var orgSrc = type;
				cmd.attr("src",type.substring(0,i)+"CUR"+type.substring(i));
				var time = 0;
				if(type==="img/forward.jpg") {
					type = "straight("+POWERstraight+")";
					time = TIMEstraight;
				} else if(type==="img/back.jpg") {
					type = "straight("+(-POWERstraight)+")";
					time = TIMEstraight;
				} else if(type==="img/spinCW.jpg") {
					type = "SPIN("+POWERspin+",true)";
					time = TIMEspin;
				} else if(type==="img/spinCCW.jpg") {
					type = "SPIN("+POWERspin+",false)"
					time = TIMEspin;
				} 
				
				//console.log(type);
				
				robotAjax(type,function() {
					setTimeout(function() {
						cmd.attr("src",orgSrc);
						nextScriptCommand();
					},time);
				});
				
			}
			
			
			function runScript() {
				$("#driveDiv").addClass("glassPane");
				
				scriptCommands = $(".programElement");
				scriptCommandsPos = 0;
				nextScriptCommand();				
												
			}
		
		</script>
	
	</head>
	
	<body>
	
	<div id="driveDiv">
	
		<div style="margin-left:50px" class="disabled">
			<img height="100" src="img/blank.jpg">
			<img height="100" src="img/forward.jpg" id="btForward">
			<br>
			<img height="100" src="img/spinCCW.jpg" id="btSpinCCW">
			<img height="100" src="img/stop.jpg"    id="btStop">
			<img height="100" src="img/spinCW.jpg"  id="btSpinCW">
			<br>
			<img height="100" src="img/blank.jpg">
			<img height="100" src="img/back.jpg"    id="btBack">
		</div>
		
		</div>
		
		<div style="margin:50px">
			<button id="btDrive" class="btn btn-primary">Drive</button>	
			<button id="btProgram" class="btn">Program</button>		
		</div>		
		
		<div id="program" style="margin:50px;display:none">		
		    <button id="btClear" class="btn">Clear</button>
			<button id="btRun" class="btn">Run</button>
			<button id="btStop" class="btn" disabled>Stop</button>
			<div id="programScript" style="margin:8px">			
		    	<img class="cursor" height="75" src="img/cursor.jpg" onclick="scriptClick(event)">
		    </div>
		</div>
	
	</body>

</html>